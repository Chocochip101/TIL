# SMTP(Simple Mail Transfer Protocol)
## 인터넷 이메일 시스템 구조

- User Agent: 사용자 장치에서 메일 작성, 읽기, 관리 기능을 수행한다.
- Mail Server: 다수 사용자들의 메일 박스 관리, 메일 송수신을 제어한다.
- SMTP: 메일 전송 프로토콜이다.

![](https://velog.velcdn.com/images/chocochip/post/e287bd86-26ea-4598-a137-604c82013811/image.png)



### 이메일 전송 과정
1. 송신자 UA에서 메일 작성 후 메일 서버로 전달한다.
2. 송신자 메일 서버의 출력 메시지 큐에 저장한다.
3. 수신자 메일 서버로 전송한다.
4. 수신자 메일 서버의 수신자 메일 박스에 저장한다.
5. 수신자 UA에서 메일 서버의 메일박스에 메일 읽기 및 관리한다.

> 전송 불가시 30분 단위로 재전송 시도, 정해진 기간 동안 전송 불가지 중단 및 송신자에게 통보

수신자의 메일 서버는 항상 listening 중이지만, 수신자는 그렇지 않다. 따라서 5번 과정은 pull 과정인 POP3, IMAP으로 이루이진다.



## SMTP


![](https://velog.velcdn.com/images/chocochip/post/afd7e21f-f44e-4a45-b7e7-9c25f77aff40/image.png)

### 특징
- 클라이언트: 송신 메일 서버/UA
- 서버: 수신 서버 메일/송신 메일 서버
- TCP 프로토콜을 이용한다.
- ASCII 텍스트 프로토콜: 명령어와 메시지 모두 ASCII 그래픽 문자 + 제어 문자를 사용한다.


### 포트
- 포트 25는 SMTP 서버 사이를 연결하는 데 가장 많이 사용된다. 스팸 발송자가 이 포트를 악용해 스팸을 대량 전송하려고 하므로, 현재는 최종 사용자 네트워크의 방화벽에서 이 포트를 차단할 때가 많다.
- 한때 포트 465는 보안 소켓 계층(SSL) 암호화와 함께 SMTP에 사용하도록 지정되었다. 하지만 SSL은 Transport Layer Security(TLS)으로 대체되어, 최신 이메일 시스템에서는 이 포트를 사용하지 않는다. 레거시(이전) 시스템에서만 나타난다.
- 이제 포트 587이 이메일 제출용 기본 포트다. 이 포트를 통과하는 SMTP 통신은 TLS 암호화를 이용한다.
- 포트 2525는 SMTP와 공식적으로 연결되어 있지는 않지만, 일부 이메일 서비스에서는 앞서 언급한 포트가 차단되었을 경우 이 포트로 SMTP 전송이 제공된다.

### 전송 과정

![](https://velog.velcdn.com/images/chocochip/post/9bbb1a4a-3aa0-4916-8445-3c5ec6b6d922/image.png)

#### 연결 수립
1. TCP 연결 수립: 송신자(SMTP Client)와 수신자(SMTP Server) 사이의 메일 서버의 25번 포트에 대한 TCP 연결을 설정한다.
2. 인사 (Greeting): 연결이 수립되면, 서버는 클라이언트에게 환영 메시지(`220 <서버 도메인 또는 IP 주소> ESMTP <서버 소프트웨어 정보>`)를 보낸다.
3. 클라이언트 응답: 클라이언트는 서버의 환영 메시지에 응답하여 자신의 신원을 확인한다.
4. 신원 확인 응답: 250 코드를 응답으로 서버는 클라이언트의 신원 확인을 성공적으로 받아들였음을 나타낸다.

#### 연결 해제
1. 전송 완료 및 종료: 메일이 성공적으로 전송되면, 클라이언트는 서버에게 전송이 완료되었음을 알리는 QUIT 명령어를 전송한다.
2. 연결 해제: QUIT 명령어의 응답 메시지로 221 코드로 응답하고 클라이언트와 서버는 TCP 연결을 종료한다.

#### 메일 전송

![](https://velog.velcdn.com/images/chocochip/post/65cd4bc8-f538-446e-9a3d-d51c59e2406a/image.png)


1. MAIL FROM: 명령어: 송신자를 명시한다.
2. RCPT TO: 명령어: 수신자를 명시한다. 
3. DATA 명령어: 메일의 본문과 헤더를 전송하기 위한 세션을 시작한다. 이후 클라이언트는 메일의 헤더와 본문을 서버로 전송합니다.
4. 메일 전송 시작: 성공적인 경우, 서버는 354 코드를 반환하며, 클라이언트는 이후 메일의 헤더와 본문을 서버로 전송할 수 있다.
5. 메일 본문 전송: 헤더 이후에는 메일의 본문을 전송합니다. 모든 라인은 `<CR><LF>`로 구분한다.
6. .(마침표) 입력: 메일의 헤더와 본문을 모두 전송한 후, .를 입력하여 전송을 완료한다.

### 메시지 포멧
![](https://velog.velcdn.com/images/chocochip/post/cc8392e8-9e28-4070-a8eb-1cf543b53c71/image.png)

### MIME(Multipurpose Internet Mail Extensions)
메일 본문 전송에서는 ASCII만 지원된다. 하지만 실사용에서는 ASCII만의 활용은 한계(오디오, 비디오)가 존재한다. 따라서 MIME을 활용하여 ASCII Data가 아닌 것을 Base64 Encoder, Decoder를 활용하여 ASCII 문자로 변환하여 전송한다. 

![](https://velog.velcdn.com/images/chocochip/post/d41fb63e-3fc4-4b20-ab19-e00c41c626de/image.png)


MIME은 전자 메일을 위한 확장 프로토콜로서, 다양한 종류의 데이터를 전자 메일로 전송하기 위한 표준을 정의한다.

![](https://velog.velcdn.com/images/chocochip/post/e0246b6f-c6bd-4612-8571-91173d566883/image.png)



## MAP (Mail Access Protocol)
MAP (Mail Access Protocol)은 전자 메일을 서버에서 클라이언트로 전달하는 데 사용되는 프로토콜이다. 주로 이메일 클라이언트가 서버에 접근하여 전자 메일을 가져오는 데에 활용된다.

### POP3
- Download&delete 또는 Download&keep: 메일을 한 번 다운로드하면 서버에서 삭제되거나 유지될지 선택할 수 있다.
- 메일 보관: 다운로드한 메일은 클라이언트의 로컬 디바이스에 저장되며, 서버에는 삭제되거나 유지될 수 있습니다.
- 메일함 동기화:
한 기기에서만 동작: POP3는 여러 기기에서 메일함 동기화를 제공하지 않습니다.
- 기본적으로 보안 부족: 기본적인 POP3는 데이터를 암호화하지 않아 보안적인 취약성이 있다.


### IMAP4

- 온라인 및 오프라인 모드 지원: 클라이언트는 온라인 및 오프라인에서 모두 메일에 액세스할 수 있습니다.
- 서버 보관: 메일은 서버에 유지되며, 클라이언트에서 읽은 상태도 서버에 반영됩니다.
- 여러 기기에서 동작: IMAP4는 여러 기기에서 메일함 동기화를 지원하여 어느 기기에서 메일을 읽거나 삭제하더라도 다른 기기에서도 동일한 상태를 유지할 수 있습니다.
- 암호화 지원: IMAPS(IMAP Secure)를 통해 SSL 또는 TLS를 사용하여 데이터를 암호화할 수 있습니다.
### HTTP
메일 서버를 웹 서버로 구현하여 웹 브라우저에서 HTTP로 메일 서버에 접속하여 통신한다.
